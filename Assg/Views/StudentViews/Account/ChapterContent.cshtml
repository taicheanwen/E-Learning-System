@model IEnumerable<Assg.Models.StudentModels.ChapterContentVM>
@using X.PagedList
@using X.PagedList.Mvc.Core

@{
    ViewData["Title"] = "Display Videos";
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">
        @TempData["ErrorMessage"]
    </div>
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}

@* <form method="get">
    @Html.TextBox("courseName", "", new { Type = "search", autofocus = "", data_trim = "" })
    <button>Search</button>
</form>
<p>@Model.Count() record(s)</p> *@

<div class="container">
    <div class="row justify-content-center">
        @foreach (var video in Model)
        {
            <div class="col-md-6 mb-4">
                <div class="card shadow-lg" style="border-radius: 15px;">
                    <div class="card-body">
                        <h5 class="card-title text-center" style="font-size: 1.5rem;">@video.CourseName</h5>

                        <p class="card-text text-center" style="font-size: 1.2rem;">
                            <strong>Price:</strong> @video.CoursePrice.ToString("C", new System.Globalization.CultureInfo("ms-MY"))
                        </p>

                        <p class="card-text text-center" style="font-size: 1rem;">
                            <strong>Description:</strong> @video.CourseDescription
                        </p>

                        <p class="card-text text-center" style="font-size: 1rem;">
                            <strong>Uploaded on:</strong> @(video.UploadDateTime?.ToShortDateString() ?? "N/A")
                        </p>


                        @if (!string.IsNullOrEmpty(video.VideoPath))
                        {
                            var videoFilePath = Url.Content($"~/{video.VideoPath}");
                            <div class="text-center">
                                <video id="video_@video.CourseId" width="100%" height="auto" controls>
                                    <source src="@videoFilePath" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div id="purchasePrompt_@video.CourseId" class="alert alert-warning mt-3" style="display:none;">
                                You need to purchase this video to continue watching.
                                <br>
                            </div>
                        }
                        else
                        {
                            <p>Invalid video URL</p>
                        }

                        <form asp-action="UpdateCart" method="post" class="text-center">
                            <input type="hidden" name="chapterContentId" value="@video.CourseId" />
                            <input type="hidden" name="subcategoryId" value="@video.SubcategoryId" />
                            <input type="hidden" name="price" value="@video.CoursePrice" />
                            <input type="hidden" name="name" value="@video.CourseName" />
                            <input type="hidden" name="description" value="@video.CourseDescription" />
                            <button type="submit" class="btn btn-primary"
                            @(video.Carts.Any(c => c.IsInCart) ? "disabled" : "")>
                                @(video.Carts.Any(c => c.IsInCart) ? "Already in Cart" : "Add to Cart")
                            </button>
                        </form>

                        <h4 class="mt-3">Reviews</h4>
                        @if (video.Reviews != null && video.Reviews.Any())
                        {
                            <ul>
                                @foreach (var review in video.Reviews)
                                {
                                    <br>
                                    <li>
                                        <strong>Review by:</strong>
                                        @{
                                            string reviewerUsername = "Unknown";
                                            if (ViewBag.UserNames.ContainsKey(review.UserId))
                                            {
                                                reviewerUsername = ViewBag.UserNames[review.UserId];
                                            }
                                        }
                                        @reviewerUsername<br />
                                        <strong>Rating:</strong>
                                        @for (var i = 1; i <= 5; i++)
                                        {
                                            if (i <= review.ReviewRate)
                                            {
                                                <span style="color: gold;">&#9733;</span>
                                            }
                                            else
                                            {
                                                <span style="color: lightgray;">&#9734;</span>
                                            }
                                        }
                                        <br />
                                        <strong>Comment:</strong> @review.ReviewText <br />
                                        <strong>Date:</strong> @review.ReviewDate.ToShortDateString()
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p>No reviews available for this course.</p>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        @foreach (var video in Model)
        {
            var videoId = "video_" + @video.CourseId;
            var purchasePromptId = "purchasePrompt_" + @video.CourseId;
            <text>
                            document.getElementById('@videoId').addEventListener('timeupdate', function() {
                                var video = document.getElementById('@videoId');
                                var currentTime = video.currentTime;
                                var duration = video.duration;

                                if (currentTime / duration > 0.2) {
                                    document.getElementById('@purchasePromptId').style.display = 'block';
                                    video.pause();
                                }
                            });
            </text>
        }
    </script>
}
