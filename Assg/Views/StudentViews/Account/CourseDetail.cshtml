@model Assg.Models.StudentModels.ChapterContentVM

<div class="container" style="height: 100vh;">
    <div class="row justify-content-center align-items-center" style="height: 100%;">
        <div class="col-md-6 mb-4">
            <div class="card shadow-lg" style="border-radius: 15px;">
                <div class="card-body">
                    <h5 class="card-title text-center" style="font-size: 1.5rem;">@Model.CourseName</h5>

                    <p class="card-text text-center" style="font-size: 1.2rem;">
                        <strong>Price:</strong> @Model.CoursePrice.ToString("C", new System.Globalization.CultureInfo("ms-MY"))
                    </p>

                    <p class="card-text text-center" style="font-size: 1rem;">
                        <strong>Description:</strong> @Model.CourseDescription
                    </p>

                    <p class="card-text text-center" style="font-size: 1rem;">
                        <strong>Uploaded on:</strong> @(Model.UploadDateTime?.ToShortDateString() ?? "N/A")
                    </p>

                    @if (!string.IsNullOrEmpty(Model.VideoPath))
                    {
                        var videoFilePath = Url.Content($"~/{Model.VideoPath}");
                        <div class="text-center">
                            <video id="video_@Model.CourseId" width="100%" height="auto" controls>
                                <source src="@videoFilePath" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div id="purchasePrompt_@Model.CourseId" class="alert alert-warning mt-3" style="display:none;">
                            You need to purchase this video to continue watching.
                            <br>
                        </div>
                    }
                    else
                    {
                        <p>Invalid video URL</p>
                    }

                    <form asp-action="UpdateCart" method="post" class="text-center">
                        <input type="hidden" name="chapterContentId" value="@Model.CourseId" />
                        <input type="hidden" name="subcategoryId" value="@Model.SubcategoryId" />
                        <input type="hidden" name="price" value="@Model.CoursePrice" />
                        <input type="hidden" name="name" value="@Model.CourseName" />
                        <input type="hidden" name="description" value="@Model.CourseDescription" />
                        <button type="submit" class="btn btn-primary"
                        @(Model.Carts.Any(c => c.IsInCart) ? "disabled" : "")>
                            @(Model.Carts.Any(c => c.IsInCart) ? "Already in Cart" : "Add to Cart")
                        </button>
                    </form>

                    <h4 class="mt-3">Reviews</h4>
                    @if (Model.Reviews != null && Model.Reviews.Any())
                    {
                        <ul>
                            @foreach (var review in Model.Reviews)
                            {
                                <br>
                                <li>
                                    <strong>Review by:</strong>
                                    @{
                                        string reviewerUsername = "Unknown";
                                        if (ViewBag.UserNames.ContainsKey(review.UserId))
                                        {
                                            reviewerUsername = ViewBag.UserNames[review.UserId];
                                        }
                                    }
                                    @reviewerUsername<br />
                                    <strong>Rating:</strong>
                                    @for (var i = 1; i <= 5; i++)
                                    {
                                        if (i <= review.ReviewRate)
                                        {
                                            <span style="color: gold;">&#9733;</span>
                                        }
                                        else
                                        {
                                            <span style="color: lightgray;">&#9734;</span>
                                        }
                                    }
                                    <br />
                                    <strong>Comment:</strong> @review.ReviewText <br />
                                    <strong>Date:</strong> @review.ReviewDate.ToShortDateString()
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p>No reviews available for this course.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        document.getElementById('video_@Model.CourseId').addEventListener('timeupdate', function() {
            var video = document.getElementById('video_@Model.CourseId');
            var currentTime = video.currentTime;
            var duration = video.duration;

            if (currentTime / duration > 0.2) {
                document.getElementById('purchasePrompt_@Model.CourseId').style.display = 'block';
                video.pause();
            }
        });
    </script>
}
